@model HappyZu.CloudStore.Web.Areas.Mobile.Models.Dest.TicketOrderViewModel

<div class="content native-scroll confirm-order">
    <div data-bind="template:{name:'ticket-template',foreach:Tickets}"></div>
    <div class="card">
        <div class="card-content">
            <div class="card-content-inner text-center">
                <a href="javascript:;" class=""><span class="iconfont icon-add"></span> 同时购买该景区其他门票</a>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-header">取票信息</div>
        <div class="card-content">
            <div class="card-content-inner form-list">
                <div class="form-row">
                    <div class="row-text">
                        取票人
                    </div>
                    <div class="row-value no-border">
                        <input class="qty-input" value="" placeholder="需要填写1个取票人"/>
                    </div>
                </div>
            </div>
            <div class="card-content-inner form-list">
                <div class="form-row">
                    <div class="row-text">
                        联系手机
                    </div>
                    <div class="row-value no-border">
                        <input class="qty-input" value="" placeholder="接收确认短信"/>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <div class="foot-clear"></div>
</div>
<div class="bar bar-footer data-choose payment-box">
    <div class="row no-gutter">
        <div class="col-75">
            <div class="payment-subtotal">
                <div class="subtotal">
                    <label>总额：</label><dfn>$</dfn><span>200</span>
                </div>
                <div class="sublist">
                    <a href="javascript:;" class="order-details-btn">明细 <span class="iconfont icon-arrow-down transactions"></span></a>
                </div>
            </div>
        </div>
        <div class="col-25">
            <div class="confirm-order-btn">
                <a href="@Url.Action("ChoosePayment","Ticket",new {area="Mobile"},true)" class="button button-big button-fill button-warning">去支付</a>
            </div>
        </div>
    </div>
</div>
@section scripts{
    <script src="~/Themes/Default/Mobile/content/plugins/knockout-3.4.0.js"></script>
    <script src="~/Themes/Default/Mobile/content/plugins/moment.min.js"></script>
    <script src="~/Themes/Default/Mobile/content/plugins/zepto.cookie.min.js"></script>
    <script src="~/Themes/Default/Mobile/content/plugins/sui/js/sm-extend.min.js"></script>
    <script src="~/Themes/Default/Mobile/content/jquery.bootstrap-touchspin.min.js"></script>
    <script type="text/html" id="ticket-template">
        <div class="card">
            <div class="card-header">
                <div class="header-title" data-bind="text:Name">

                </div>
                <div class="header-active">
                    <a href="javascript:;" class="ticket-description">购买须知</a>
                    <a href="javascript:;" data-bind="visible:$parent.Tickets().length>1" class="remove-ticket"><span class="iconfont icon-delete"></span></a>
                </div>
            </div>
            <div class="card-content">
                <div class="card-content-inner form-row">
                    <div class="row-text">使用日期</div>
                    <div class="row-value choose-date-box" data-bind="template:{name:'ticket-quotes',foreach:Quotes}">

                    </div>
                </div>
            </div>
            <div class="card-footer form-row">
                <div class="row-text">
                    购买份数
                </div>
                <div class="row-value ticket-quantity">
                    <input class="qty-input" data-bind="value:Quantity"/>
                </div>
            </div>
        </div>
    </script>
    <script type="text/html" id="ticket-quotes">
        <div class="choose-date " data-bind="css: { selected: Selected },click:$root.ChangeDate">
            <div class="choose-item" data-bind="css: { more: $index()>1 }">
                <label data-bind="text:$root.DateName($data)"></label>
                <div class="price">
                    <dfn>$</dfn>
                    <span data-bind="text:Quote.Price"></span>
                </div>
            </div>
        </div>
    </script>
    <script>
        var ticketVM = @Html.Raw(Json.Encode(Model));
        var Ticket = function(ticket) {
            $.extend(this, ticket);
            this.Quantity = ko.observable(1);
            this.Quotes = ko.observableArray([]);
        };

        var QuoteModel = function(quote) {
            $.extend(this, quote);
            this.Selected = ko.observable(false);;
        };

        var ViewModel = function() {
            var $this = this;
            $this.Contact = ko.observable('');
            $this.Mobile = ko.observable('');
            $this.Tickets = ko.observableArray([]);
            $this.load = function() {
                var ticket = new Ticket(ticketVM.Ticket);
                for (var i = 0; i < ticketVM.TicketQuotes.length; i++) {
                    var quote = new QuoteModel(ticketVM.TicketQuotes[i]);
                    if (i === 0) {
                        quote.Selected(true);
                    }
                    ticket.Quotes.push(quote);
                }
                $this.Tickets.push(ticket);
            };
            $this.DateName = function(data) {
                if (moment().isSame(data.Year + '-' + data.Month + '-' + data.Day, 'Day')) {
                    return '今日';
                }
                if (moment().add(1, 'days').isSame(data.Year + '-' + data.Month + '-' + data.Day, 'Day')) {
                    return '明日';
                }

                if (data.Selected()) {
                    return data.Month + '月' + data.Day + '日';
                } else {
                    return '更多日期';
                }
            };
            $this.ChangeDate=function(data,index) {
                var tickets = $this.Tickets();
                for (var i = 0; i < tickets.length; i++) {
                    var ticket = tickets[i];
                    if (ticket.Id===data.TicketId) {
                        var quotes = ticket.Quotes();
                        for (var j = 0; j < quotes.length; j++) {
                            if (quotes[j].Id===data.Id) {
                                quotes[j].Selected(true);
                            } else {
                                quotes[j].Selected(false);
                            }
                        }
                    }
                }
            }
        };

        var vm = new ViewModel();

        ko.applyBindings(vm);

        $(function() {
            vm.load();
            var spin = $('.ticket-quantity .qty-input').TouchSpin({ min: 1, max: 99 });

            $(document).on("touchspin.on.min", '.qty-input', function() {
                $.toast("最少要购买1份");
            });

            $('.order-details-btn').on('click', function() {
                var $this = $(this);
                if (!$this.hasClass('selected')) {
                    $this.addClass('selected');
                } else {
                    $this.removeClass('selected');
                }
            });

            $(document).on('click', '.remove-ticket', function() {
                $.confirm('确定要删除吗?', function() {
                    $.alert('You clicked Ok button');
                });
            });
        })
    </script>
}