@using Senparc.Weixin.MP
@using Senparc.Weixin.MP.AdvancedAPIs
@model HappyZu.CloudStore.Trip.Dto.TicketOrderDto

<div class="content native-scroll">
    <div class="order-info">
        <div class="info-body">@Model.DestName 门票</div>
        <div class="order-total">
            <label>订单金额：</label>
            <dfn>￥</dfn><span>@Model.TotalAmount</span>
        </div>
    </div>
    <div class="list-block">
        <ul>
            <li>
                <a href="javascript:payment();" class="item-link item-content">
                    <div class="item-media"><i class="iconfont" style="color: #00c000; font-size: 28px;">&#xe64c;</i>
                    </div>
                    <div class="item-inner">
                        <div class="item-title">微信支付</div>
                    </div>
                </a>
            </li>
        </ul>
    </div>
</div>
@section scripts{
    <script>
        function payment() {
            var url = '@Url.Action("JsApi", "Payment", new {area = "Mobile"}, true)';
            var params = { orderId: '@Model.Id' };
            $.post(url, params, function(data) {
                if (data.success) {
                    if (data.result.msg==='OpenIdIsEmpty') {
                        window.location='@Html.Raw(OAuthApi.GetAuthorizeUrl(ViewBag.AppId, Url.Action("Bindings","Wechat",new {area="Mobile"},true),Request.RawUrl, OAuthScope.snsapi_base))';
                    }
                    if (data.result.msg !=null && data.result.msg!=='') {
                        $.alert(data.result.msg);
                    }
                    gopay(data.result);
                } else {
                    $.alert('程序错误');
                }
            }, 'json');
        }

        function gopay(data) {
            WeixinJSBridge.invoke('getBrandWCPayRequest', {
                "appId": data.appId, //公众号名称，由商户传入
                "timeStamp":data.timeStamp, //时间戳
                   "nonceStr": data.nonceStr, //随机串
                   "package":data.packageValue,//扩展包
                   "signType": "MD5", //微信签名方式:MD5
                   "paySign":data.paySign //微信签名
            }, function (res) {
                $.alert(res.err_msg);
                if (res.err_msg == "get_brand_wcpay_request:ok") {

                }
                // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠。
                //因此微信团队建议，当收到ok返回时，向商户后台询问是否收到交易成功的通知，若收到通知，前端展示交易成功的界面；若此时未收到通知，商户后台主动调用查询订单接口，查询订单的当前状态，并反馈给前端展示相应的界面。
            });
        }
    </script>
}