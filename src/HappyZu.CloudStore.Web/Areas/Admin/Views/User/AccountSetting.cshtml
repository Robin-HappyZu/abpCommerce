@using Abp.Json
@using HappyZu.CloudStore.Authorization
@model HappyZu.CloudStore.Web.Areas.Admin.Models.ProfileSidebarViewModel
@{
    ViewBag.Title = "编辑用户资料";
}

<!-- BEGIN PAGE BAR -->
<div class="page-bar">
    <ul class="page-breadcrumb">
        <li>
            <a href="@Url.Action("Index",new {controller="Dashboard"})">控制面板</a>
            <i class="fa fa-angle-right"></i>
        </li>
        <li>
            <a href="@Url.Action("List",new {controller="User"})">用户列表</a>
            <i class="fa fa-angle-right"></i>
        </li>
        <li>
            <span>@ViewBag.Title</span>
        </li>
    </ul>
</div>
<!-- END PAGE BAR -->
<!-- BEGIN PAGE TITLE-->
<h3 class="page-title">
    编辑资料
    <small>用户资料设置</small>
</h3>
<!-- END PAGE TITLE-->
<div class="row">
    <div class="col-md-12">
        <!-- BEGIN PROFILE SIDEBAR -->
        <div class="profile-sidebar">
            <!-- PORTLET MAIN -->
            <div class="portlet light bordered profile-sidebar-portlet ">
                <!-- SIDEBAR USERPIC -->
                <div class="profile-userpic">
                    <img src="~/Areas/Admin/content/pages/img/avatars/avatar.jpg" class="img-responsive" alt="">
                </div>
                <!-- END SIDEBAR USERPIC -->
                <!-- SIDEBAR USER TITLE -->
                <div class="profile-usertitle">
                    <div class="profile-usertitle-name"> @Model.User.Name </div>
                    <div class="profile-usertitle-job"> @Model.RoleName  <a href="javascript:;"><span class="fa fa-edit"></span></a></div>
                </div>
                <!-- END SIDEBAR USER TITLE -->
                <!-- SIDEBAR BUTTONS -->
                @*<div class="profile-userbuttons">
                <button type="button" class="btn btn-circle green btn-sm"> <i class="fa fa-heart"></i> 关注</button>
                <button type="button" class="btn btn-circle red btn-sm"> <i class="fa fa-comments"></i> 留言</button>
            </div>*@
                <!-- END SIDEBAR BUTTONS -->
                <!-- SIDEBAR MENU -->
                <div class="profile-usermenu">
                    <ul class="nav">
                        <li class="active">
                            <a href="@Url.Action("AccountSetting")">
                                <i class="icon-settings"></i> 编辑用户资料
                            </a>
                        </li>
                    </ul>
                </div>
                <!-- END MENU -->
            </div>
        </div>
        <!-- END BEGIN PROFILE SIDEBAR -->
        <!-- BEGIN PROFILE CONTENT -->
        <div class="profile-content">
            <div class="row">
                <div class="col-md-12">
                    <div class="portlet light bordered">
                        <div class="portlet-title tabbable-line">
                            <div class="caption caption-md">
                                <i class="icon-globe theme-font hide"></i>
                                <span class="caption-subject font-blue-madison bold uppercase">账户资料</span>
                            </div>
                            <ul class="nav nav-tabs">
                                <li class="active">
                                    <a href="#tab_1_1" data-toggle="tab">个人信息</a>
                                </li>
                                <li>
                                    <a href="#tab_1_3" data-toggle="tab">修改密码</a>
                                </li>
                            </ul>
                        </div>
                        <div class="portlet-body">
                            <div class="tab-content">
                                <!-- PERSONAL INFO TAB -->
                                <div class="tab-pane active" id="tab_1_1">
                                    <form role="form" action="#">
                                        <div class="form-group">
                                            <label class="control-label">真实姓名</label>
                                            <input type="text" data-bind="value:Surname" placeholder="真实姓名" class="form-control" />
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label">昵称</label>
                                            <input type="text" placeholder="昵称" data-bind="value:Name" class="form-control" />
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label">手机号码</label>
                                            <input type="text" placeholder="手机号码" data-bind="value:Mobile" class="form-control" />
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label">邮箱</label>
                                            <input type="text" placeholder="Email" data-bind="value:EmailAddress" class="form-control" />
                                        </div>
                                        <div class="margiv-top-10">
                                            <a href="javascript:;" data-bind="click:SaveUserInfo" data-loading-text="正在保存..." class="btn green"> 保存 </a>
                                            <a href="javascript:;" data-bind="click:Cancel" class="btn default"> 取消 </a>
                                        </div>
                                    </form>
                                </div>
                                <!-- END PERSONAL INFO TAB -->
                                <!-- CHANGE PASSWORD TAB -->
                                <div class="tab-pane" id="tab_1_3">
                                    
                                    @if (IsGranted(PermissionNames.Administrator_UserRestPassword))
                                    {
                                        //权限验证
                                        <form action="#">
                                            <div class="form-group">
                                                <label class="control-label">新密码</label>
                                                <input type="password" data-bind="value:Password" class="form-control" />
                                            </div>
                                            <div class="form-group">
                                                <label class="control-label">确认密码</label>
                                                <input type="password" data-bind="value:RePassword" class="form-control"/>
                                            </div>
                                            <div class="margin-top-10">
                                                <a href="javascript:;" data-bind="click:SavePassword" class="btn green"> 修改密码 </a>
                                                <a href="javascript:;" data-bind="click:Cancel" class="btn default"> 取消 </a>
                                            </div>
                                        </form>
                                    }
                                    else
                                    {
                                        <div>您没有权限进行此操作</div>
                                    }
                                </div>
                                <!-- END CHANGE PASSWORD TAB -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END PROFILE CONTENT -->
    </div>
</div>
@section style_plugins{
    <link href="~/Areas/Admin/content/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css" rel="stylesheet" type="text/css" />
}
@section styles{
    <link href="~/Areas/Admin/content/pages/css/profile.min.css" rel="stylesheet" type="text/css" />
}
@section script_plugins{
    <script src="~/Areas/Admin/content/global/plugins/bootstrap-fileinput/bootstrap-fileinput.js" type="text/javascript"></script>
    <script src="~/Areas/Admin/content/global/plugins/jquery.sparkline.min.js" type="text/javascript"></script>
}
@section scripts{
    <script src="~/Areas/Admin/content/pages/scripts/profile.min.js" type="text/javascript"></script>
    <script>
        var user = @Html.Raw(Model.User.ToJsonString());

        var ViewModel = function(u) {
            var $this = this;
            $this.Surname = ko.observable(u.Surname);
            $this.Name = ko.observable(u.Name);
            $this.Mobile = ko.observable(u.PhoneNumber);
            $this.EmailAddress = ko.observable(u.EmailAddress);

            $this.Password = ko.observable();
            $this.RePassword = ko.observable();

            $this.Cancel = function() {
                window.location = '@Request["ReturnUrl"]';
            }

            $this.SaveUserInfo = function(data, event) {
                var url = '@Url.Action("SetAdminUserInfo", "User", new {area = "Admin"}, true)';
                var params = {
                    UserId:'@Model.User.Id',
                    Surname: $this.Surname(),
                    Name: $this.Name(),
                    Mobile: $this.Mobile(),
                    EmailAddress: $this.EmailAddress()
                };
                App.startPageLoading({animate: true});
                var $btn=$(event.target);
                $btn.button("loading");
                $.post(url, params, function(data) {
                    var type = 'info';
                    var message = '';
                    var icon = 'info';
                    if (data.success) {
                        if (data.result.status) {
                            message = '保存成功';
                        } else {
                            message = '保存失败';
                            icon = 'warning';
                            type = 'danger';
                        }
                    } else {
                        type = 'danger';
                        message = data.error.message;
                        icon = 'warning';
                    };
                    App.alert({
                        container: '',
                        place: 'append', // append or prepent in container
                        type: type,  // alert's type
                        message: message,  // alert's message
                        close: true, // make alert closable
                        reset: true, // close all previouse alerts first
                        focus: true, // auto scroll to the alert after shown
                        icon: icon // put icon before the message
                    });
                    $btn.button('reset');
                    App.stopPageLoading();
                }, 'json');
            }

            $this.SavePassword = function(data, event) {
                if ($this.Password()!=$this.RePassword()) {
                    App.alert({
                        container: '',
                        place: 'append', // append or prepent in container
                        type: 'danger',  // alert's type
                        message: '两次输入的密码不同',  // alert's message
                        close: true, // make alert closable
                        reset: true, // close all previouse alerts first
                        focus: true, // auto scroll to the alert after shown
                        icon: 'warning' // put icon before the message
                    });
                    return;
                }

                var url = '@Url.Action("SetAdminPassword", "User", new {area = "Admin"}, true)';
                var params = {
                    UserId:'@Model.User.Id',
                    Password: $this.Password()
                };
                App.startPageLoading({animate: true});
                var $btn=$(event.target);
                $btn.button("loading");
                $.post(url, params, function(data) {
                    var type = 'info';
                    var message = '';
                    var icon = 'info';
                    if (data.success) {
                        if (data.result.status) {
                            message = '保存成功';
                        } else {
                            message = '保存失败';
                            icon = 'warning';
                            type = 'danger';
                        }
                    } else {
                        type = 'danger';
                        message = data.error.message;
                        icon = 'warning';
                    };
                    App.alert({
                        container: '',
                        place: 'append', // append or prepent in container
                        type: type,  // alert's type
                        message: message,  // alert's message
                        close: true, // make alert closable
                        reset: true, // close all previouse alerts first
                        focus: true, // auto scroll to the alert after shown
                        icon: icon // put icon before the message
                    });
                    $btn.button('reset');
                    App.stopPageLoading();
                }, 'json');
            }
        }

        var vm = new ViewModel(user);
        ko.applyBindings(vm);
    </script>
}
