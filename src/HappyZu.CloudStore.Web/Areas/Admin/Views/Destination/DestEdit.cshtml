@model HappyZu.CloudStore.Web.Areas.Admin.Models.EditDestViewModel


@using Abp.Json
@{
    ViewBag.Title = "编辑景点";
}

<!-- BEGIN PAGE BAR -->
<div class="page-bar">
    <ul class="page-breadcrumb">
        <li>
            <a href="@Url.Action("Index", "Dashboard",new {area="Admin"},true)">控制面板</a>
            <i class="fa fa-angle-right"></i>
        </li>
        <li>
            <a href="@Url.Action("Index", "Destination",new {area="Admin"},true)">景点管理</a>
            <i class="fa fa-angle-right"></i>
        </li>
        <li>
            <span>@ViewBag.Title</span>
        </li>
    </ul>
</div>
<!-- END PAGE BAR -->
<!-- BEGIN PAGE TITLE-->


<div class="row">
    <div class="col-md-12 col-sm-12">
        <div class="zone zone-content">
            <div class="portlet solid portlet-box">
                <div class="portlet-title">
                    <div class="caption">
                        @ViewBag.Title
                    </div>
                    <div class="actions content-edit-box-actions">
                        <button type="button" onclick="javascript:OpenWindow('/flower-girl-bracelet', 800, 600, true); return false;" class="btn purple">
                            <i class="fa fa-eye"></i>
                            预览
                        </button>
                        <button type="submit" name="save" class="btn blue" data-loading-text="正在保存..." data-bind="click:submit">
                            <i class="fa fa-floppy-o"></i>
                            保存
                        </button>
                        <button type="submit" name="save-continue" class="btn blue">
                            <i class="fa fa-floppy-o"></i>
                            保存并继续编辑
                        </button>
                        <button type="button" name="copyproduct" class="btn green-meadow" data-toggle="modal" data-target="#copyproduct-window">
                            <i class="fa fa-clone"></i>
                            复制景点
                        </button>
                        <span id="product-delete" class="btn red" data-toggle="modal" data-target="#productmodel-delete-confirmation">
                            <i class="fa fa-trash-o"></i>
                            删除
                        </span>
                    </div>
                </div>
                <div class="portlet-body">
                    @using (Html.BeginForm("DestEdit", "Destination", FormMethod.Post, new { id = "uiform" }))
                    {
                        @Html.Partial("_DestCreateOrEdit")
                    }
                </div>
            </div>

        </div>
    </div>
</div>
<div class="clearfix">
</div>
@section style_plugins{
    <link href="~/Areas/Admin/content/global/plugins/bootstrap-summernote/summernote.css" rel="stylesheet" />
}
@section script_plugins{
    <script src="~/Areas/Admin/content/global/plugins/bootstrap-summernote/summernote.min.js"></script>
    <script src="~/Areas/Admin/content/global/plugins/bootstrap-summernote/lang/summernote-zh-CN.js"></script>
}
@section scripts{
    <script>
        $(function () {
            $(".input-booking-notice").summernote({ height: 300, dialogsInBody: true, placeholder: '预订须知', lang: "zh-CN" ,callbacks: {
                onBlur: function() {
                    vm.BookingNotice($(".input-booking-notice").val());
                }
            }});
            $(".input-agreement").summernote({ height: 300, dialogsInBody: true, placeholder: '游玩协议', lang: "zh-CN" ,callbacks: {
                onBlur: function(contents, $editable) {
                    vm.Agreement($(".input-agreement").val());
                }
            }});
            $(".input-description").summernote({ height: 300, dialogsInBody: true, placeholder: '景点介绍', lang: "zh-CN" ,callbacks: {
                onBlur: function(contents, $editable) {
                    vm.Introduce($(".input-description").val());
                }
            }});
        });

        function htmldecode(s){
            var div = document.createElement('div');
            div.innerHTML = s;
            return div.innerText || div.textContent;
        }
        function htmlencode(s){  
            var div = document.createElement('div');  
            div.appendChild(document.createTextNode(s));  
            return div.innerHTML;  
        }  

        var ViewModel = function (title, subject, introduce, feature, openTime, isPublished, publishDateTime, displayOrder,
            destType, provinceId, cityId, address, lng, lat, supplierId, supplier, bookingNotice, agreement, metaTitle,
            metaKeywords, metaDescription, returnUrl) {
            var _this = this;
            this.Title = ko.observable(title);
            this.Subject = ko.observable(subject);
            this.Introduce = ko.observable(htmldecode(introduce));
            this.Feature = ko.observable(feature);
            this.OpenTime = ko.observable(openTime);
            this.IsPublished = ko.observable(isPublished);
            this.PublishDateTime = ko.observable(publishDateTime);
            this.DisplayOrder = ko.observable(displayOrder);
            this.DestType = ko.observable(destType);
            this.ProvinceId = ko.observable(provinceId);
            this.CityId = ko.observable(cityId);
            this.Address = ko.observable(address);
            this.Lng = ko.observable(lng);
            this.Lat = ko.observable(lat);
            this.SupplierId = ko.observable(supplierId);
            this.Supplier = ko.observable(supplier);
            this.BookingNotice = ko.observable(htmldecode(bookingNotice));
            this.Agreement = ko.observable(htmldecode(agreement));
            this.MetaTitle = ko.observable(metaTitle);
            this.MetaKeywords = ko.observable(metaKeywords);
            this.MetaDescription = ko.observable(metaDescription);
            this.ReturnUrl = ko.observable(returnUrl);

            this.submit = function(data, event) {
                var url = $('#uiform').attr("action");
                var params = [];
                params.push({ name: "@Html.NameFor(m=>m.Dest.Title)", value: _this.Title() });
                params.push({ name: "@Html.NameFor(m=>m.Dest.Subject)", value: _this.Subject() });
                params.push({ name: "@Html.NameFor(m=>m.Dest.Introduce)", value:htmlencode(_this.Introduce()) });
                params.push({ name: "@Html.NameFor(m=>m.Dest.Feature)", value: _this.Feature() });
                params.push({ name: "@Html.NameFor(m=>m.Dest.OpenTime)", value: _this.OpenTime() });
                params.push({ name: "@Html.NameFor(m=>m.Dest.IsPublished)", value: _this.IsPublished() });
                params.push({ name: "@Html.NameFor(m=>m.Dest.PublishDateTime)", value: _this.PublishDateTime() });
                params.push({ name: "@Html.NameFor(m=>m.Dest.DisplayOrder)", value: _this.DisplayOrder() });
                params.push({ name: "@Html.NameFor(m=>m.Dest.DestType)", value: _this.DestType() });
                params.push({ name: "@Html.NameFor(m=>m.Dest.ProvinceId)", value: _this.ProvinceId() });
                params.push({ name: "@Html.NameFor(m=>m.Dest.CityId)", value: _this.CityId() });
                params.push({ name: "@Html.NameFor(m=>m.Dest.Address)", value: _this.Address() });
                params.push({ name: "@Html.NameFor(m=>m.Dest.Lng)", value: _this.Lng() });
                params.push({ name: "@Html.NameFor(m=>m.Dest.Lat)", value: _this.Lat() });
                params.push({ name: "@Html.NameFor(m=>m.Dest.SupplierId)", value: _this.SupplierId() });
                params.push({ name: "@Html.NameFor(m=>m.Dest.Supplier)", value: _this.Supplier() });
                params.push({ name: "@Html.NameFor(m=>m.Dest.BookingNotice)", value: htmlencode(_this.BookingNotice()) });
                params.push({ name: "@Html.NameFor(m=>m.Dest.Agreement)", value: htmlencode(_this.Agreement()) });
                params.push({ name: "@Html.NameFor(m=>m.Dest.MetaTitle)", value: _this.MetaTitle() });
                params.push({ name: "@Html.NameFor(m=>m.Dest.MetaKeywords)", value: _this.MetaKeywords() });
                params.push({ name: "@Html.NameFor(m=>m.Dest.MetaDescription)", value: _this.MetaDescription() });
                App.startPageLoading({animate: true});
                var $btn=$(event.target);
                $btn.button("loading");
                $.post(url, params, function(data) {
                    if (data.success) {
                        window.location = _this.ReturnUrl();
                        return;
                    } else {
                        App.alert({
                            container: '',
                            place: 'append', // append or prepent in container
                            type: 'danger',  // alert's type
                            message: data.error.message,  // alert's message
                            close: true, // make alert closable
                            reset: true, // close all previouse alerts first
                            focus: true, // auto scroll to the alert after shown
                            icon: 'warning' // put icon before the message
                        });
                    };
                    $btn.button('reset');
                    App.stopPageLoading();
                }, 'json');

            }
        };

        var vm = new ViewModel( "@Model.Dest.Title", "@Model.Dest.Subject","@Model.Dest.Introduce","@Model.Dest.Feature" ,
            "@Model.Dest.OpenTime",@Model.Dest.IsPublished.ToJsonString(),"@Model.Dest.PublishDateTime", @Model.Dest.DisplayOrder,
            @((int)Model.Dest.DestType), @Model.Dest.ProvinceId, @Model.Dest.CityId, "@Model.Dest.Address", "@Model.Dest.Lng",
            "@Model.Dest.Lat", @Model.Dest.SupplierId, "@Model.Dest.Supplier", "@Model.Dest.BookingNotice", "@Model.Dest.Agreement",
            "@Model.Dest.MetaTitle","@Model.Dest.MetaKeywords", "@Model.Dest.MetaDescription", "@Request["ReturnUrl"]");

        ko.applyBindings(vm);


    </script>
}